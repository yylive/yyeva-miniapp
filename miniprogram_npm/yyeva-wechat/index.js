var oe=class{constructor(e){this.requestAnim=this.returnRequestAnim(),this.cancelAnim=this.returnCancelAnim(),this.op=e,this.frameStartTime=0,this.frameDelay=0,this.currentTime=0,this.fps=0,this.frame=0}init({fps:e}){this.fps=e||20,this.frameDelay=1e3/this.fps}currentTimeMillsecond(){return new Date().getTime()}start(){this.frameDelay===0&&this.fps>0&&(this.frameDelay=1e3/this.fps),console.debug("animator start",this.animateId,this.frameDelay,this.fps),this.frameStartTime=this.currentTimeMillsecond(),this.cancelAnim(),this.requestAnim(this.drawFrame)}stop(){console.debug("animator stop",this.animateId),this.frame=0,this.currentTime=0,this.cancelAnim()}reset(){this.frame=0,this.currentTime=0}destroy(){this.cancelAnim(),this.op=void 0,this.cancelAnim=void 0,this.requestAnim=void 0,this.onUpdate=void 0}setCurrentTime(e){this.currentTime=e}drawFrame(){this.cancelAnim(),this.requestAnim(this.drawFrame);let e=this.currentTime;this.frame=this.getCurrentFrame(e),this.onUpdate&&this.onUpdate()}getCurrentFrame(e=0){return Math.round(e*this.fps)}returnRequestAnim(){return e=>this.op.canvas.requestAnimationFrame(()=>{let t=this.currentTimeMillsecond(),n=t-this.frameStartTime;if(n>this.frameDelay)return this.frameStartTime=t-n%this.frameDelay,e.call(this);this.requestAnim&&(this.animateId=this.requestAnim(e))})}returnCancelAnim(){return()=>this.animateId&&this.op.canvas.cancelAnimationFrame(this.animateId)}},ge=oe;var q=class{constructor(e,t){this.loopCount=1/0;this.playedLoopCount=0;let n=typeof e;n==="boolean"?this.loopCount=e?1/0:1:n==="number"&&(this.loopCount=Number(e)),this.onLoop=t}destroy(){this.onLoop=void 0}addLoop(){return this.playedLoopCount<this.loopCount&&(this.playedLoopCount=this.playedLoopCount+1,this.onLoop&&this.onLoop(this.playedLoopCount)),this.playedLoopCount!=this.loopCount}};var N=class{constructor(e,t){this.op=e,this.filePath=t||e.videoUrl,this.op.mute||(this.mediaAudioPlayer=wx.createMediaAudioPlayer()),this.videoDecoder=wx.createVideoDecoder(),wx.onMemoryWarning(this.onMemoryWarning)}setup(){this.onStart&&this.videoDecoder.on("start",this.onStart),this.onStop&&this.videoDecoder.on("stop",this.onStop),this.onSeek&&this.videoDecoder.on("seek",this.onSeek),this.onBufferchange&&this.videoDecoder.on("bufferchange",this.onBufferchange),this.onEnd&&this.videoDecoder.on("ended",this.onEnd)}seek(e){console.debug("[videoDecoder] seek",e)}start(){this.startVideoPlayer(),this.startAudioPlayer()}stop(){this.stopAudioPlayer(),this.stopVideoPlayer()}startVideoPlayer(){let e={source:this.filePath,mode:1};console.debug("[videoDecoder] video start",e),this.videoDecoder.start(e).then(t=>{console.debug("[videoDecoder] start resolve")})}stopVideoPlayer(){this.videoDecoder.stop()}startAudioPlayer(){this.op.mute||this.mediaAudioPlayer.start().then(()=>{this.mediaAudioPlayer.addAudioSource(this.videoDecoder).then(e=>{console.debug("[mediaAudioPlayer]")})})}stopAudioPlayer(){this.op.mute||(this.mediaAudioPlayer.stop(),this.mediaAudioPlayer.removeAudioSource(this.videoDecoder))}getFrameData(){return this.videoDecoder.getFrameData()}destroy(){this.op.mute||(this.mediaAudioPlayer.destroy(),this.mediaAudioPlayer=void 0),this.mediaAudioPlayer=void 0,this.onStart&&this.videoDecoder.off("start",this.onStart),this.onStop&&this.videoDecoder.off("stop",this.onStop),this.onSeek&&this.videoDecoder.off("seek",this.onSeek),this.onBufferchange&&this.videoDecoder.off("bufferchange",this.onBufferchange),this.onEnd&&this.videoDecoder.off("ended",this.onEnd),this.videoDecoder.remove(),this.videoDecoder=void 0,this.onStart=void 0,this.onStop=void 0,this.onSeek=void 0,this.onBufferchange=void 0,this.onEnd=void 0,this.op=void 0,wx.offMemoryWarning(this.onMemoryWarning)}onMemoryWarning(e){console.warn("onMemoryWarning",e)}debug2D(e){if(this.op.canvas2d){this.op.canvas2d.height=e.height,this.op.canvas2d.width=e.width;let t=this.op.canvas2d.createImageData(e.data,e.width,e.height);this.op.ctx2d.clearRect(0,0,e.width,e.height),this.op.ctx2d.putImageData(t,0,0)}}};var ae=class{constructor(e,t){this.op=e,this.animator=new ge(e),this.renderNullTime=0,this.MaxNullTime=50,this.loopChecker=new q(e.loop,e.onLoop),this.player=new N(e,t),this.player.onStart=n=>{console.debug("[onStart]",JSON.stringify(n)),this.info=n,this.playStart(n),this.op.onStart&&this.op.onStart(n)},this.player.onStop=n=>{console.debug("[onStop]",n),this.animator.stop(),this.op.onStop&&this.op.onStop(n)},this.player.onSeek=n=>{console.debug("[onSeek]",n.position)},this.player.onBufferchange=n=>{},this.player.onEnd=async n=>{console.debug("[ended]",n),await this.playEnd()},this.player.setup(),this.animator.onUpdate=()=>{this.render()}}playStart(e){this.onInit&&this.onInit(e),this.animator.init({fps:this.op.fps||e.fps}),this.animator.start()}async playEnd(){this.stop(),this.animator.stop(),console.debug("this.op.loop",this.op.loop),this.loopChecker.addLoop()?this.start():(console.debug("[video onEnd]",this.op.videoUrl),this.onEnd&&this.onEnd(),this.op.onEnd&&this.op.onEnd())}render(){let e=this.player.getFrameData();if(!e){this.renderNullTime++,this.animator.frame>0&&this.renderNullTime>=this.MaxNullTime&&(this.playEnd(),this.renderNullTime=0);return}this.renderNullTime=0,this.animator.setCurrentTime(e.pkDts/1e3),this.onUpdate&&this.onUpdate(this.animator.frame,e),this.player.debug2D(e)}start(){this.isStart=!0,this.player.start()}stop(){this.isStart=!1,this.player.stop()}seek(e){this.player.seek(e)}destroy(){this.isStart&&this.stop(),this.animator.destroy(),this.player.destroy(),this.loopChecker.destroy(),this.player=void 0,this.info=void 0,this.animator=void 0,this.renderNullTime=0,this.MaxNullTime=0,this.loopChecker=void 0,this.onUpdate=void 0,this.onInit=void 0,this.onEnd=void 0,this.render=void 0}},be=ae;var se=wx.getSystemInfoSync(),R=se.pixelRatio,We=se.pixelRatio,ce=se.platform;var V=class{constructor(e){this.op=e,this.canvas=wx.createOffscreenCanvas({type:"2d",width:300,height:300}),this.canvas&&(this.ctx=this.canvas.getContext("2d"))}destroy(){this.op=void 0,this.canvas=void 0,this.ctx=void 0}parseFromSrcAndOptions(e){if(!e)return;let t=this.op.effects||{};return Promise.all(e.map(async n=>{let i=n.effectType,o=n.effectTag;i==="txt"?(n.text=t[o],n.img=await this.makeTextImg(n)):i==="img"&&(n.img=await this.makeImage(n,t[o]))}))}_getText(e,t,n){var i,o,h,y;if(console.debug("_getText text=",t,n,(o=(i=this.op)==null?void 0:i.font)==null?void 0:o.overflow),!((y=(h=this.op)==null?void 0:h.font)!=null&&y.overflow)||this.op.font.overflow==="cut"){let u=e.measureText(t).width;if(n==null)n=u;else if(u>n){let m=t.length;for(;e.measureText(t+"...").width>n&&m>0;)m=m-1,t=t.substring(0,m);t=t+"..."}}return console.debug("text=",t),t}async makeTextImg(e){if(!this.ctx)return;let t=this.ctx,{fontStyle:n,fontColor:i,fontSize:o}=e,h=e.effectWidth,y=e.effectHeight;t.canvas.width=h,t.canvas.height=y,t.textBaseline="middle",t.textAlign="center";let u=e.text||"",m=g=>{g=g||Math.min(h/u.length,y-8);let b=["600",`${Math.round(g)}px`,"Microsoft YaHei"];return n==="b"&&b.unshift("bold"),b.join(" ")};if(n)typeof n=="string"?(t.font=n,i&&(t.fillStyle=i)):typeof n=="object"?(t.font=n.font||m(),t.fillStyle=n.color||i):typeof n=="function"&&(t.font=m(o),i&&(t.fillStyle=i),n(null,t,e));else{let g=m(e.fontSize);t.font=g,i&&(t.fillStyle=i)}return t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillText(this._getText(t,u,h),h/2,y/2),t.getImageData(0,0,h,y)}async makeImage(e,t){if(!this.ctx)return;let n=this.ctx,i=e.effectWidth,o=e.effectHeight;if(!t)return n.clearRect(0,0,i,o),n.getImageData(0,0,i,o);let h=await this.createImage(t);n.canvas.width=i,n.canvas.height=o;let y=i,u=o,m=0,g=0;if(e.scaleMode)switch(e.scaleMode){case"aspectFill":{let b=1;i/o>h.width/h.height?b=i/h.width:b=o/h.height,y=Math.round(h.width*b),u=Math.round(h.height*b),m=-Math.round(Math.abs(y-i)/2),g=-Math.round(Math.abs(u-o)/2)}break;case"aspectFit":{let b=1;i/o<h.width/h.height?b=i/h.width:b=o/h.height,y=Math.round(h.width*b),u=Math.round(h.height*b),m=-Math.round(Math.abs(y-i)/2),g=-Math.round(Math.abs(u-o)/2)}break;case"scaleFill":break;default:}return n.save(),n.translate(0,0),n.scale(1,1),n.drawImage(h,m,g,y,u),n.restore(),n.getImageData(0,0,i,o)}createImage(e){return new Promise((t,n)=>{let o=wx.createOffscreenCanvas({type:"2d",width:300,height:300}).createImage();o.src=e,o.onload=()=>{t(o)},o.onerror=h=>n(h)})}};var Z=9,U=class{destory(){this.clear(),this.texture=void 0,this.op=void 0,this.program=void 0,this.textureMap=void 0,this.efectKey=void 0,this.buffers=void 0,this.textures=void 0,this.canvasVideo=void 0}constructor(){this.textureMap={},this.buffers={},this.textures={}}async setup(e,t){this.op=e,this.metadatas=t,this.efectKey=new V(e);let n={alpha:!0,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,premultipliedAlpha:!0,stencil:!1,preserveDrawingBuffer:!1},o=e.canvas.getContext("webgl",n);if(!o){console.error("Unable to get webgl context.");return}this.gl=o;let{effect:h}=this.metadatas||{};await this.efectKey.parseFromSrcAndOptions(h)}setOnVideoInit(e){let{descript:t,effect:n}=this.metadatas||{},i=this.gl,o=this.op,h={};if(!t)h.width=e.width?e.width/2*R:900,h.height=e.height?e.height*R:1e3;else{let[E,C,w,d]=t.rgbFrame;h.width=w*R,h.height=d*R}this.canvasVideo=h,ce==="ios"?(i.canvas.width=o.canvasClient.width*R,i.canvas.height=o.canvasClient.height*R):(i.canvas.width=h.width,i.canvas.height=h.height),i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight),i.disable(i.BLEND),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0);let{fs:y,vs:u}=this.getVSFS(),m=this.createShader(i,u,i.VERTEX_SHADER),g=this.createShader(i,y,i.FRAGMENT_SHADER),b=this.createProgram(i,m,g);if(!b)return;this.program=b,i.useProgram(b),this.initTexture(n);let v=i.getAttribLocation(b,"a_position"),T=i.getAttribLocation(b,"a_texCoord"),S=i.getAttribLocation(b,"a_alpha_texCoord");i.enableVertexAttribArray(v),i.enableVertexAttribArray(T),i.enableVertexAttribArray(S);let p=this.getViewPos({descript:t,alphaDirection:o.alphaDirection,vw:e.width,vh:e.height});this.buffers.globalBuffer=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.buffers.globalBuffer),i.bufferData(i.ARRAY_BUFFER,p,i.STATIC_DRAW);let r=p.BYTES_PER_ELEMENT;i.vertexAttribPointer(v,2,i.FLOAT,!1,r*6,0),i.vertexAttribPointer(T,2,i.FLOAT,!1,r*6,r*2),i.vertexAttribPointer(S,2,i.FLOAT,!1,r*6,r*4);let s=i.getUniformLocation(b,"u_scale"),x=this.getScale(o.mode);i.uniform2fv(s,new Float32Array(x))}getFrame(e){let{datas:t}=this.metadatas||{};if(!!t)return t&&t.find(n=>n.frameIndex===e)}renderDesc(e){let{descript:t}=this.metadatas||{},n=this.gl,i=this.program;if(t&&e>0){let o=[],h=t.width,y=t.height,u=this.getFrame(e),m=u?u.data:void 0;m&&m.forEach(v=>{o[o.length]=+this.textureMap[v.effectId];let[T,S]=t.rgbFrame,[p,r,s,x]=v.renderFrame,[E,C,w,d]=v.outputFrame,c=this.computeCoord(p+T,r+S,s,x,h,y),f=this.computeCoord(E,C,w,d,h,y);o=o.concat(c).concat(f)});let g=(n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS)-1)*Z;o=o.concat(new Array(g-o.length).fill(0));let b=n.getUniformLocation(i,"image_pos");n.uniform1fv(b,new Float32Array(o))}}destroy(){this.clear(),this.efectKey.destroy(),this.texture=void 0,this.gl=void 0,this.op=void 0,this.program=void 0,this.metadatas=void 0,this.textureMap=void 0,this.efectKey=void 0,this.buffers=void 0,this.textures=void 0,this.canvasVideo=void 0}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}render(e,t){let n=this.gl;this.renderDesc(e),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t.width,t.height,0,n.RGBA,n.UNSIGNED_BYTE,new Uint8Array(t.data)),this.clear(),n.drawArrays(n.TRIANGLE_STRIP,0,4)}initTexture(e){let t=this.gl,n=this.program,i=this.textureMap,o=1;if(e){for(let u in e){let m=e[u];m.img&&this.createTexture(t,o,m.img);let g=t.getUniformLocation(n,`u_image${o}`);t.uniform1i(g,o),i[m.effectId]=o++}let y=t.createTexture();t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,y),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null)}this.createTexture(t,o);let h=t.getUniformLocation(n,"u_image_video");t.uniform1i(h,o)}createTexture(e,t,n){this.textures[t]=e.createTexture();let i=e.TEXTURE0+t;e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,this.textures[t]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),n&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,n.width,n.height,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array(n.data))}getScale(e){let t=1,n=1,i=this.op.canvasClient.width,o=this.op.canvasClient.height,h,y;ce==="ios"?(h=this.canvasVideo.width,y=this.canvasVideo.height):(h=this.op.canvas.width,y=this.op.canvas.height);let u=i/o,m=h/y;if(e)switch(e){case"AspectFill":case"vertical":n=1,t=m/u;break;case"AspectFit":case"horizontal":t=1,n=u/m;break;case"Fill":case"cover":n=1,t=m/u,t<1&&(n=1/t,t=1);break;case"contain":n=1,t=m/u,t>1&&(n=1/t,t=1);break;case"Normal":break;default:break}return[t,n]}computeCoord(e,t,n,i,o,h){return[e/o,(e+n)/o,(h-t-i)/h,(h-t)/h]}getViewPos(e){let t=[],{rgbX:n,rgbY:i,rgbW:o,rgbH:h,vW:y,vH:u,aX:m,aY:g,aW:b,aH:v}=this.getRgbaPos(e),T=this.computeCoord(n,i,o,h,y,u),S=this.computeCoord(m,g,b,v,y,u);return t.push(-1,1,T[0],T[3],S[0],S[3]),t.push(1,1,T[1],T[3],S[1],S[3]),t.push(-1,-1,T[0],T[2],S[0],S[2]),t.push(1,-1,T[1],T[2],S[1],S[2]),new Float32Array(t)}getRgbaPos({descript:e,alphaDirection:t,vw:n,vh:i}){let o;if(e){let{width:h,height:y}=e,[u,m,g,b]=e.rgbFrame,[v,T,S,p]=e.alphaFrame;o={rgbX:u,rgbY:m,rgbW:g,rgbH:b,vW:h,vH:y,aX:v,aY:T,aW:S,aH:p}}else{let h=n||1800,y=i||1e3,u=h/2,[m,g,b,v]=t==="right"?[0,0,u,y]:[u,0,u,y],[T,S,p,r]=t==="right"?[u,0,u,y]:[0,0,u,y];o={rgbX:m,rgbY:g,rgbW:b,rgbH:v,vW:h,vH:y,aX:T,aY:S,aW:p,aH:r}}return o}createProgram(e,t,n){let i=e.createProgram();return e.attachShader(i,t),e.attachShader(i,n),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)?i:(e.deleteProgram(i),null)}createShader(e,t,n){let i=e.createShader(n);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)||console.error("Error compiling shader: "+e.getShaderInfoLog(i)),i}getVSFS(){let e=this.gl,t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS)-1,n="",i="";if(t>0){let u=[],m=[];for(let g=0;g<t;g++)u.push(`if(ndx == ${g+1}){
                          color = texture2D(u_image${g+1},uv);
                      }`),m.push(`uniform sampler2D u_image${g+1};`);i=`
              ${m.join(`
`)}
              uniform float image_pos[${t*Z}];
              vec4 getSampleFromArray(int ndx, vec2 uv) {
                  vec4 color;
                  ${u.join(" else ")}
                  return color;
              }
              `,n=`
              vec4 srcColor,maskColor;
              vec2 srcTexcoord,maskTexcoord;
              int srcIndex;
              float x1,x2,y1,y2,mx1,mx2,my1,my2; //\u663E\u793A\u7684\u533A\u57DF
  
              for(int i=0;i<${t*Z};i+= ${Z}){
                  if ((int(image_pos[i]) > 0)) {
                    srcIndex = int(image_pos[i]);
                      x1 = image_pos[i+1];
                      x2 = image_pos[i+2];
                      y1 = image_pos[i+3];
                      y2 = image_pos[i+4];
  
                      mx1 = image_pos[i+5];
                      mx2 = image_pos[i+6];
                      my1 = image_pos[i+7];
                      my2 = image_pos[i+8];
  
                      if (v_texcoord.s>x1 && v_texcoord.s<x2 && v_texcoord.t>y1 && v_texcoord.t<y2) {
                          srcTexcoord = vec2((v_texcoord.s-x1)/(x2-x1),(v_texcoord.t-y1)/(y2-y1));
                           maskTexcoord = vec2(mx1+srcTexcoord.s*(mx2-mx1),my1+srcTexcoord.t*(my2-my1));
                           srcColor = getSampleFromArray(srcIndex,srcTexcoord);
                           maskColor = texture2D(u_image_video, maskTexcoord);
                           srcColor.a = srcColor.a*(maskColor.r);
                           bgColor = vec4(srcColor.rgb*srcColor.a,srcColor.a) + (1.0-srcColor.a)*bgColor;
                      }
                  }
              }
              `}let o=`
    attribute vec2 a_position;
    attribute vec2 a_texCoord;
    attribute vec2 a_alpha_texCoord;
    varying vec2 v_texcoord;
    varying vec2 v_alpha_texCoord;
    uniform vec2 u_scale;
    void main(void){
      gl_Position = vec4(u_scale * a_position, 0.0, 1.0);
      v_texcoord = a_texCoord;
      v_alpha_texCoord = a_alpha_texCoord;
    }
  `;return{fs:`
    precision lowp float;
    varying vec2 v_texcoord;
    varying vec2 v_alpha_texCoord;
    uniform sampler2D u_image_video;
    ${i}
    void main(void) {
      vec4 bgColor = vec4(texture2D(u_image_video, v_texcoord).rgb, texture2D(u_image_video,v_alpha_texCoord).r);
      ${n}
      gl_FragColor = bgColor;
    }
  `,vs:o}}};var O=Object.freeze({UNCOMPRESSED:0,FIXED:1,DYNAMIC:2});var J=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],H=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],X=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],de=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function W(a){let e=Object.keys(a),t=0,n=0,i=Number.MAX_SAFE_INTEGER;e.forEach(u=>{t=Number(u),n<t&&(n=t),i>t&&(i=t)});let o=0,h,y={};for(let u=i;u<=n;u++){h=a[u],h===void 0&&(h=[]),h.sort((g,b)=>g<b?-1:g>b?1:0);let m={};h.forEach(g=>{m[o]=g,o++}),y[u]=m,o<<=1}return y}function ye(){let a={};a[7]=[],a[8]=[],a[9]=[];for(let e=0;e<=287;e++)e<=143?a[8].push(e):e<=255?a[9].push(e):e<=279?a[7].push(e):a[8].push(e);return a}var k=class{constructor(e,t=0){this.buffer=e,this.bufferIndex=t,this.nowBits=e[t],this.nowBitsLength=8,this.isEnd=!1}read(){if(this.isEnd)throw new Error("Lack of data length");let e=this.nowBits&1;return this.nowBitsLength>1?(this.nowBitsLength--,this.nowBits>>=1):(this.bufferIndex++,this.bufferIndex<this.buffer.length?(this.nowBits=this.buffer[this.bufferIndex],this.nowBitsLength=8):(this.nowBitsLength=0,this.isEnd=!0)),e}readRange(e){for(;this.nowBitsLength<=e;)this.nowBits|=this.buffer[++this.bufferIndex]<<this.nowBitsLength,this.nowBitsLength+=8;let t=this.nowBits&(1<<e)-1;return this.nowBits>>>=e,this.nowBitsLength-=e,t}readRangeCoded(e){let t=0;for(let n=0;n<e;n++)t<<=1,t|=this.read();return t}};var ee=class{constructor(e){this.buffer=new Uint8Array(e),this.length=e,this._extendedSize=e,this.index=0}write(e){if(this.length<=this.index){this.length+=this._extendedSize;let t=new Uint8Array(this.length),n=this.buffer.length;for(let i=0;i<n;i++)t[i]=this.buffer[i];this.buffer=t}this.buffer[this.index]=e,this.index++}};var Ae=W(ye());function xe(a,e=0){let t=new ee(a.length*10),n=new k(a,e),i=0,o=0;for(;i!==1;){if(i=n.readRange(1),o=n.readRange(2),o===O.UNCOMPRESSED)_e(n,t);else if(o===O.FIXED)Ie(n,t);else if(o===O.DYNAMIC)De(n,t);else throw new Error("Not supported BTYPE : "+o);if(i===0&&n.isEnd)throw new Error("Data length is insufficient")}return t.buffer.subarray(0,t.index)}function _e(a,e){a.nowBitsLength<8&&a.readRange(a.nowBitsLength);let t=a.readRange(8)|a.readRange(8)<<8,n=a.readRange(8)|a.readRange(8)<<8;if(t+n!==65535)throw new Error("Data is corrupted");for(let i=0;i<t;i++)e.write(a.readRange(8))}function Ie(a,e){let t=Ae,n=Object.keys(t),i=0,o=0,h=Number.MAX_SAFE_INTEGER;n.forEach(r=>{i=Number(r),o<i&&(o=i),h>i&&(h=i)});let y=0,u,m,g,b,v,T,S,p;for(;!a.isEnd;){for(u=void 0,i=h,y=a.readRangeCoded(h);u=t[i][y],u===void 0;){if(o<=i)throw new Error("Data is corrupted");i++,y<<=1,y|=a.read()}if(u<256){e.write(u);continue}if(u===256)break;m=u-257,g=H[m],b=J[m],0<b&&(g+=a.readRange(b)),v=a.readRangeCoded(5),T=X[v],S=Q[v],0<S&&(T+=a.readRange(S)),p=e.index-T;for(let r=0;r<g;r++)e.write(e.buffer[p+r])}}function De(a,e){let t=a.readRange(5)+257,n=a.readRange(5)+1,i=a.readRange(4)+4,o=0,h={};for(let A=0;A<i;A++)o=a.readRange(3),o!==0&&(h[o]||(h[o]=[]),h[o].push(de[A]));let y=W(h),u=Object.keys(y),m=0,g=Number.MAX_SAFE_INTEGER;u.forEach(A=>{o=Number(A),m<o&&(m=o),g>o&&(g=o)});let b={},v={},T=0,S,p=0,r=0,s=t+n;for(let A=0;A<s;){for(S=void 0,o=g,T=a.readRangeCoded(g);S=y[o][T],S===void 0;){if(m<=o)throw new Error("Data is corrupted");o++,T<<=1,T|=a.read()}if(S===16?p=3+a.readRange(2):S===17?(p=3+a.readRange(3),r=0):S===18?(p=11+a.readRange(7),r=0):(p=1,r=S),r<=0)A+=p;else for(;p;)A<t?(b[r]||(b[r]=[]),b[r].push(A++)):(v[r]||(v[r]=[]),v[r].push(A++-t)),p--}let x=W(b),E=W(v),C=Object.keys(x),w=0,d=0,c=Number.MAX_SAFE_INTEGER;C.forEach(A=>{w=Number(A),d<w&&(d=w),c>w&&(c=w)});let f=Object.keys(E),l=0,G=0,F=Number.MAX_SAFE_INTEGER;f.forEach(A=>{l=Number(A),G<l&&(G=l),F>l&&(F=l)});let B=0,D,Y,j,$,P,z,K,L,M,re;for(;!a.isEnd;){for(D=void 0,w=c,B=a.readRangeCoded(c);D=x[w][B],D===void 0;){if(d<=w)throw new Error("Data is corrupted");w++,B<<=1,B|=a.read()}if(D<256){e.write(D);continue}if(D===256)break;for(Y=D-257,j=H[Y],$=J[Y],0<$&&(j+=a.readRange($)),P=void 0,L=F,M=a.readRangeCoded(F);P=E[L][M],P===void 0;){if(G<=L)throw new Error("Data is corrupted");L++,M<<=1,M|=a.read()}z=X[P],K=Q[P],0<K&&(z+=a.readRange(K)),re=e.index-z;for(let A=0;A<j;A++)e.write(e.buffer[re+A])}}function we(a){let e=new k(a);if(e.readRange(4)!==8)throw new Error("Not compressed by deflate");let n=e.readRange(4),i=e.readRange(5),o=e.readRange(1),h=e.readRange(2);return xe(a,2)}var te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Re=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;var Te=function(a){if(a=String(a).replace(/[\t\n\f\r ]+/g,""),!Re.test(a))throw new TypeError("Failed to execute 'atob' on 'Window': The string to be decoded is not correctly encoded.");a+="==".slice(2-(a.length&3));let e,t="",n,i,o=0;for(;o<a.length;)e=te.indexOf(a.charAt(o++))<<18|te.indexOf(a.charAt(o++))<<12|(n=te.indexOf(a.charAt(o++)))<<6|(i=te.indexOf(a.charAt(o++))),t+=n===64?String.fromCharCode(e>>16&255):i===64?String.fromCharCode(e>>16&255,e>>8&255):String.fromCharCode(e>>16&255,e>>8&255,e&255);return t};function Se(a){let e,t,n,i,o;for(e="",t=0;t<a.length;)switch(n=a[t++],n>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:e+=String.fromCharCode(n);break;case 12:case 13:i=a[t++],e+=String.fromCharCode((n&31)<<6|i&63);break;case 14:i=a[t++],o=a[t++],e+=String.fromCharCode((n&15)<<12|(i&63)<<6|(o&63)<<0);break}return e}function ne(a){let e=function(p){let r=[],s,x,E,C,w,d,c,f,l;for(p=S(p),r=v(p),d=1732584193,c=4023233417,f=2562383102,l=271733878,s=0;s<r.length;s+=16)x=d,E=c,C=f,w=l,d=u(d,c,f,l,r[s+0],7,3614090360),l=u(l,d,c,f,r[s+1],12,3905402710),f=u(f,l,d,c,r[s+2],17,606105819),c=u(c,f,l,d,r[s+3],22,3250441966),d=u(d,c,f,l,r[s+4],7,4118548399),l=u(l,d,c,f,r[s+5],12,1200080426),f=u(f,l,d,c,r[s+6],17,2821735955),c=u(c,f,l,d,r[s+7],22,4249261313),d=u(d,c,f,l,r[s+8],7,1770035416),l=u(l,d,c,f,r[s+9],12,2336552879),f=u(f,l,d,c,r[s+10],17,4294925233),c=u(c,f,l,d,r[s+11],22,2304563134),d=u(d,c,f,l,r[s+12],7,1804603682),l=u(l,d,c,f,r[s+13],12,4254626195),f=u(f,l,d,c,r[s+14],17,2792965006),c=u(c,f,l,d,r[s+15],22,1236535329),d=m(d,c,f,l,r[s+1],5,4129170786),l=m(l,d,c,f,r[s+6],9,3225465664),f=m(f,l,d,c,r[s+11],14,643717713),c=m(c,f,l,d,r[s+0],20,3921069994),d=m(d,c,f,l,r[s+5],5,3593408605),l=m(l,d,c,f,r[s+10],9,38016083),f=m(f,l,d,c,r[s+15],14,3634488961),c=m(c,f,l,d,r[s+4],20,3889429448),d=m(d,c,f,l,r[s+9],5,568446438),l=m(l,d,c,f,r[s+14],9,3275163606),f=m(f,l,d,c,r[s+3],14,4107603335),c=m(c,f,l,d,r[s+8],20,1163531501),d=m(d,c,f,l,r[s+13],5,2850285829),l=m(l,d,c,f,r[s+2],9,4243563512),f=m(f,l,d,c,r[s+7],14,1735328473),c=m(c,f,l,d,r[s+12],20,2368359562),d=g(d,c,f,l,r[s+5],4,4294588738),l=g(l,d,c,f,r[s+8],11,2272392833),f=g(f,l,d,c,r[s+11],16,1839030562),c=g(c,f,l,d,r[s+14],23,4259657740),d=g(d,c,f,l,r[s+1],4,2763975236),l=g(l,d,c,f,r[s+4],11,1272893353),f=g(f,l,d,c,r[s+7],16,4139469664),c=g(c,f,l,d,r[s+10],23,3200236656),d=g(d,c,f,l,r[s+13],4,681279174),l=g(l,d,c,f,r[s+0],11,3936430074),f=g(f,l,d,c,r[s+3],16,3572445317),c=g(c,f,l,d,r[s+6],23,76029189),d=g(d,c,f,l,r[s+9],4,3654602809),l=g(l,d,c,f,r[s+12],11,3873151461),f=g(f,l,d,c,r[s+15],16,530742520),c=g(c,f,l,d,r[s+2],23,3299628645),d=b(d,c,f,l,r[s+0],6,4096336452),l=b(l,d,c,f,r[s+7],10,1126891415),f=b(f,l,d,c,r[s+14],15,2878612391),c=b(c,f,l,d,r[s+5],21,4237533241),d=b(d,c,f,l,r[s+12],6,1700485571),l=b(l,d,c,f,r[s+3],10,2399980690),f=b(f,l,d,c,r[s+10],15,4293915773),c=b(c,f,l,d,r[s+1],21,2240044497),d=b(d,c,f,l,r[s+8],6,1873313359),l=b(l,d,c,f,r[s+15],10,4264355552),f=b(f,l,d,c,r[s+6],15,2734768916),c=b(c,f,l,d,r[s+13],21,1309151649),d=b(d,c,f,l,r[s+4],6,4149444226),l=b(l,d,c,f,r[s+11],10,3174756917),f=b(f,l,d,c,r[s+2],15,718787259),c=b(c,f,l,d,r[s+9],21,3951481745),d=n(d,x),c=n(c,E),f=n(f,C),l=n(l,w);return(T(d)+T(c)+T(f)+T(l)).toLowerCase()},t=function(p,r){return p<<r|p>>>32-r},n=function(p,r){let s=p&2147483648,x=r&2147483648,E=p&1073741824,C=r&1073741824,w=(p&1073741823)+(r&1073741823);return E&C?w^2147483648^s^x:E|C?w&1073741824?w^3221225472^s^x:w^1073741824^s^x:w^s^x},i=function(p,r,s){return p&r|~p&s},o=function(p,r,s){return p&s|r&~s},h=function(p,r,s){return p^r^s},y=function(p,r,s){return r^(p|~s)},u=function(p,r,s,x,E,C,w){return p=n(p,n(n(i(r,s,x),E),w)),n(t(p,C),r)},m=function(p,r,s,x,E,C,w){return p=n(p,n(n(o(r,s,x),E),w)),n(t(p,C),r)},g=function(p,r,s,x,E,C,w){return p=n(p,n(n(h(r,s,x),E),w)),n(t(p,C),r)},b=function(p,r,s,x,E,C,w){return p=n(p,n(n(y(r,s,x),E),w)),n(t(p,C),r)},v=function(p){let r,s=p.length,x=s+8,C=((x-x%64)/64+1)*16,w=Array(C-1),d=0,c=0;for(;c<s;)r=(c-c%4)/4,d=c%4*8,w[r]=w[r]|p.charCodeAt(c)<<d,c++;return r=(c-c%4)/4,d=c%4*8,w[r]=w[r]|128<<d,w[C-2]=s<<3,w[C-1]=s>>>29,w},T=function(p){let r="",s="",x,E;for(E=0;E<=3;E++)x=p>>>E*8&255,s="0"+x.toString(16),r=r+s.substr(s.length-2,2);return r},S=function(p){p=p.toString().replace(/\x0d\x0a/g,`
`);let r="";for(let s=0;s<p.length;s++){let x=p.charCodeAt(s);x<128?r+=String.fromCharCode(x):x>127&&x<2048?(r+=String.fromCharCode(x>>6|192),r+=String.fromCharCode(x&63|128)):(r+=String.fromCharCode(x>>12|224),r+=String.fromCharCode(x>>6&63|128),r+=String.fromCharCode(x&63|128))}return r};return e(a)}var le=class{get fs(){return wx.getFileSystemManager()}access(e){let t=this.fs;return new Promise(n=>{t.access({path:e,success(){n(e)},fail(){n(void 0)}})})}readFileInBinary(e){return new Promise((t,n)=>{this.fs.readFile({filePath:e,success:t,fail:n,encoding:"binary"})})}readFile(e){let t=this.fs;return new Promise((n,i)=>{t.readFile({filePath:e,encoding:"utf8",position:0,success(o){n(o.data)},fail(o){i(o)}})})}touchDirectory(e){let t=this.fs;try{t.accessSync(e)}catch(n){try{t.mkdirSync(e)}catch{console.error(n)}}}writeFile(e,t){let n=this.fs;new Promise((i,o)=>{n.writeFile({filePath:e,data:t,encoding:"utf8",success:i,fail:o})})}writeFileSync(e,t){let n=this.fs;try{n.writeFileSync(e,t,"utf8")}catch(i){throw new Error(i)}}removeFile(e){console.log("removeFile, path:",e);let t=this.fs;try{t.accessSync(e),t.unlinkSync(e)}catch(n){console.error(n)}}clearDirectory(e){let t=this.fs;try{let n=t.readdirSync(e);return n.length>0&&n.forEach(i=>{t.unlinkSync(`${e}${i}`)}),!0}catch(n){return console.error(n),!1}}checkFileExist(e){return new Promise(t=>{wx.getFileInfo({filePath:e,success(){t(!0)},fail(){t(!1)}})})}},_=new le;var Ee=10,fe=class{constructor(){this._fileCacheInfos=[];this.avalible=!0;this._checkAvalible(),this._fs=wx.getFileSystemManager(),this._getStorageInfo()}_checkAvalible(){return wx.setStorage===void 0||wx.getStorageInfo===void 0||wx.batchGetStorage===void 0?this.avalible=!1:this.avalible=!0,console.log("[CacheManager] _checkAvalible, avalible=",this.avalible),this.avalible}saveIndex(e,t){if(!this.avalible){console.log("[CacheManager] saveIndex not avalible");return}return new Promise((n,i)=>{console.debug("[saveIndex] setStorage filePath=",t,", url=",e);let o=t,h={url:e,filePath:t,time:new Date().getTime()},y=!1;for(let u=0;u<this._fileCacheInfos.length;++u)if(this._fileCacheInfos[u].filePath===t){y=!0;break}y||this._fileCacheInfos.push(h),this._checkCache(),wx.setStorage({key:o,data:h,success:n,fail:i})})}_checkCache(){if(this._fileCacheInfos.sort(function(e,t){return e.time-t.time}),console.debug("_checkCache: this._fileCacheInfos=",this._fileCacheInfos),this._fileCacheInfos.length>Ee){let e=this._fileCacheInfos.length-Ee;for(let t=0;t<e;++t){let n=this._fileCacheInfos[t];n.filePath?(_.removeFile(n.filePath),wx.removeStorage({key:n.filePath})):console.debug("_checkCache item_i.filePath is undefined, item_i=",n)}this._fileCacheInfos.splice(0,e),console.debug("_checkCache...after, count=",this._fileCacheInfos.length,", deleteCount=",e)}}_getStorageInfo(){if(!this.avalible){console.log("[CacheManager] _getStorageInfo not avalible");return}wx.getStorageInfo({success:e=>{console.debug("getSorageInfo:keys",e.keys,e.currentSize,e.limitSize),e&&e.keys&&e.keys.length>0&&wx.batchGetStorage({keyList:e.keys,success:t=>{if(t&&t.dataList){for(let n of t.dataList)this._fileCacheInfos.push(n);this._checkCache()}}})}})}},ve=new fe;var Pe=new RegExp("yyeffectmp4json\\[\\[(.*?)\\]\\]yyeffectmp4json"),he=class{constructor(){this.fs=wx.getFileSystemManager(),this.filePath=`${wx.env.USER_DATA_PATH}/yyeva`,_.touchDirectory(this.filePath)}setup(e){this.op=e}async downloadVideo(e){let t,n,i=this.getFilenameByUrl(e);if(console.debug("[downloadVideo] fileName=",i,", url=",e,"useVideoDBCache=",this.op.useVideoDBCache),!i)return;t=this.getFilePath(i),this.op.useVideoDBCache&&(n=await _.access(t));let o=!1;if(n)o=!0,console.debug("[downloadVideo in cache]",e,t);else{let h=await this.downloadFile(e,t);console.debug("[downloadVideo in http] file=",h),h&&(t=h.filePath,o=!0)}return o&&this.op.useVideoDBCache&&ve.saveIndex(e,t),t}async getMetaData(e){let t=`${e}.json`;console.debug("jsonFilePath",t);let n,i=!1;if(this.op.useVideoDBCache&&(i=await _.access(t)),console.debug("hasJsonPath",i),i&&this.op.useVideoDBCache)n=await _.readFile(t),console.debug("[metadata in cache]",t);else{let{data:o}=await _.readFileInBinary(e);if(!o)return;let h=o.match(Pe);if(!h)return;let y=h[1],u=we(new Uint8Array(this.base64ToArrayBuffer(y)));n=Se(u),n&&this.op.useVideoDBCache&&(console.log("jsonFilePath writeFile",t),await _.writeFile(t,n))}return n=JSON.parse(n),n}downloadFile(e,t){return new Promise((n,i)=>{wx.downloadFile({filePath:t,url:e,success:n,fail:i})})}getFilePath(e){return`${this.filePath}/${e}`}getFilenameByUrl(e){let t=e.split("/").pop();return ne(e)+"_"+t}base64ToArrayBuffer(e){let t=Te(e),n=t.length,i=new Uint8Array(n);for(let o=0;o<n;o++)i[o]=t.charCodeAt(o);return i.buffer}},ie=new he;var ue=class{constructor(){this.webgl=new U,this.currentFrame=-1,this.isShow=!0}async setup(e){this.op=e,this.op.onDestory&&(this.onDestroy=this.op.onDestory),ie.setup(e),await this.parserVideo(),console.debug("[webgl] setup start"),await this.webgl.setup(e,this.metadatas),console.debug("[VideoPlayer] new"),this.video=new be(e,this.filePath),this.video.onInit=t=>{console.debug("[video onInit]",t),this.webgl.setOnVideoInit(t)},this.video.onUpdate=(t,n)=>{this.currentFrame!==t&&(!n.data||!this.isShow||(this.webgl.render(t,n),this.currentFrame=t))},this.video.onEnd=()=>{console.debug("video onEnd"),this.destroy(),this.currentFrame=-1}}async parserVideo(){let e=await ie.downloadVideo(this.op.videoUrl);return e&&(this.filePath=e,this.metadatas=await ie.getMetaData(e),console.debug("[player] getMetaData done!")),this.metadatas}start(){this.video.start()}stop(){this.video.stop()}destroy(){this.video.isStart&&this.stop(),this.video.destroy(),this.webgl.destroy(),this.metadatas=void 0,this.filePath=void 0,this.currentFrame=-1,this.webgl=void 0,this.video=void 0,this.op=void 0,this.onDestroy&&this.onDestroy()}};async function pe(a){let e=new ue;return a={...{loop:!1,alphaDirection:"right",mute:!1,useVideoDBCache:!0,mode:"contain",font:{overflow:"cut"}},...a},await e.setup(a),e}var me={version:"1.0.0-beta.15",env:"prod"};var I={};console.debug(`[yyeva wechat ${me.env}] v${me.version}`);Component({properties:{options:{type:Object,value:{}}},data:{canvasId:"",canvas2dId:"",isLoad:!1},methods:{onEnd(a){this.triggerEvent("onEnd",a)},onStart(a){this.triggerEvent("onStart",a)},onStop(a){this.triggerEvent("onStop",a)},async _startToPlay(){if(!this.data.options.videoUrl||!this.data.isLoad)return;let a=this.data.options.videoUrl,e=ne(a),t=`yyeva-webgl-${e}`;this.setData({canvasId:t});let[n,i]=await Promise.all([this._getNode(t),this._getClientRect(t)]),o,h;if(this.data.options.showVideo){let u=`yyeva-canvas2d-${e}`;this.setData({canvas2dId:u}),o=await this._getNode(u),h=o.getContext("2d")}let y={canvas:n,canvasClient:i,canvas2d:o,ctx2d:h,onEnd:u=>this.onEnd(u),onStop:u=>this.onStop(u),onStart:u=>this.onStart(u),onDestory:()=>{delete I[a]},...this.data.options};I[a]=await pe(y),I[a].start()},_getNode(a){let e=this.createSelectorQuery();return a=`#${a}`,new Promise(t=>{e.select(a).node(n=>t(n.node)).exec()})},_getClientRect(a){let e=this.createSelectorQuery();return a=`#${a}`,new Promise(t=>{e.select(a).boundingClientRect(t).exec()})},_setPlayerIsShow(a){let e=this.data.options.videoUrl;I[e]&&(I[e].isShow=a)}},observers:{"options.**":function(a){this._startToPlay()}},lifetimes:{created(){},attached(){},async ready(){this.setData({isLoad:!0}),this._startToPlay()},moved(){},detached(){let a=this.data.options.videoUrl;a&&I[a]&&(I[a].destroy&&I[a].destroy(),delete I[a]),this.setData({isLoad:!1})},error(a){console.error("[lifetimes error]",a)}},pageLifetimes:{show(){this._setPlayerIsShow(!0)},hide(){this._setPlayerIsShow(!1)},resize(a){}}});
/**
 * @license Copyright (c) 2018 zprodev
 */
//# sourceMappingURL=index.js.map